@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  /* --- START: SURGICAL ADDITION --- */
  /* 
    ==============================================
    PROFESSIONAL COLOR & THEME SYSTEM (LIGHT & DARK)
    ==============================================
  */
  :root {
    /* -- Brand Colors -- */
    --brand-primary: 46 125 50; /* A deep, trustworthy green for primary actions. */
    --brand-primary-hover: 27 94 32; /* A darker shade for hover states. */
    --brand-secondary: 79 70 229; /* A vibrant indigo for community features. */
    --brand-secondary-hover: 67 56 202;
    --brand-accent: 245 158 11; /* A warm amber for accents and warnings. */
    --brand-accent-hover: 217 119 6;

    /* -- Backgrounds -- */
    --bg-default: 248 250 252; /* slate-50 */
    --bg-subtle: 241 245 249; /* slate-100 */
    --bg-inset: 226 232 240; /* slate-200 */

    /* -- Content (Text) -- */
    --content-default: 30 41 59; /* slate-800 */
    --content-subtle: 71 85 105; /* slate-600 */
    --content-on-brand: 255 255 255; /* white */
    
    /* -- Borders -- */
    --stroke-default: 203 213 225; /* slate-300 */
    --stroke-subtle: 226 232 240; /* slate-200 */

    /* -- Status -- */
    --status-success: 34 197 94;
    --status-warning: 234 179 8;
    --status-error: 239 68 68;
    --status-info: 59 130 246;
  }

  :root.dark {
    /* -- Brand Colors -- */
    --brand-primary: 52 211 153; /* A brighter, more vivid green for dark mode contrast. */
    --brand-primary-hover: 16 185 129;
    --brand-secondary: 99 102 241; /* A slightly brighter indigo. */
    --brand-secondary-hover: 129 140 248;
    --brand-accent: 251 191 36; /* A brighter amber. */
    --brand-accent-hover: 252 211 77;

    /* -- Backgrounds -- */
    --bg-default: 15 23 42; /* slate-900 */
    --bg-subtle: 30 41 59; /* slate-800 */
    --bg-inset: 51 65 85; /* slate-700 */

    /* -- Content (Text) -- */
    --content-default: 226 232 240; /* slate-200 */
    --content-subtle: 148 163 184; /* slate-400 */
    --content-on-brand: 15 23 42; /* slate-900, for primary buttons in dark mode */

    /* -- Borders -- */
    --stroke-default: 51 65 85; /* slate-700 */
    --stroke-subtle: 47 55 73; /* A custom shade between slate-700/800 */

    /* -- Status -- */
    --status-success: 74 222 128;
    --status-warning: 250 204 21;
    --status-error: 248 113 113;
    --status-info: 96 165 250;
  }
  /* --- END: SURGICAL ADDITION --- */

  /* CRITICAL FIX: Ensure html and body fill viewport properly */
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
  }
  
  /* --- START: MOBILE VIEWPORT FIX (WebXR AR) --- */
  /* Prevent mobile Safari address bar from shifting AR content */
  html {
    height: 100vh; /* Fallback for older browsers */
    height: 100dvh; /* Dynamic viewport height - adapts when browser UI retracts (Chrome 108+, Safari 15.4+) */
    height: -webkit-fill-available; /* iOS Safari specific fallback */
  }

  body {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-height: 100vh;
    min-height: 100dvh; /* Dynamic viewport height for mobile */
    min-height: -webkit-fill-available;
    /* --- START: SURGICAL REPLACEMENT --- */
    /* Applying a theme-aware background using our new CSS variables. */
    @apply bg-background-default text-content-default;
    /* --- END: SURGICAL REPLACEMENT --- */
  }
  /* --- END: MOBILE VIEWPORT FIX (WebXR AR) --- */

  /* --- START: SURGICAL ADDITION (BROWSER STYLE OVERRIDE) --- */
  /*
    ==============================================
    CUSTOM FORM & BROWSER OVERRIDES
    ==============================================
  */
  html {
    /* This ensures form elements respect the dark/light mode */
    color-scheme: light dark;
  }
  
  /* Hide ugly default arrows on number inputs */
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type="number"] {
    -moz-appearance: textfield;
  }
  /* --- END: SURGICAL ADDITION (BROWSER STYLE OVERRIDE) --- */

  /* --- START: MODAL SCROLL LOCK --- */
  /*
    ==============================================
    MODAL BODY SCROLL LOCK (CLASS-BASED)
    ==============================================
    Prevents body scroll when modal is open.
    Class-based approach is safer than style mutation.
  */
  body.modal-open {
    overflow: hidden;
  }
  /* --- END: MODAL SCROLL LOCK --- */
}


/*
  ==============================================
  MODERN THEMATIC PROGRESS BAR
  ==============================================
*/
.progress-bar-container {
  /* --- START: SURGICAL MODIFICATION --- */
  @apply w-full bg-background-inset rounded-full h-2.5 overflow-hidden;
  /* --- END: SURGICAL MODIFICATION --- */
}

.progress-bar-animated {
  @apply h-full w-full;
  background-image: linear-gradient(
    90deg,
    rgb(var(--brand-primary)),
    rgb(var(--brand-secondary)),
    rgb(var(--brand-primary))
  );
  background-size: 300% 100%;
  animation: progress-animation 2.5s ease-in-out infinite;
}

@keyframes progress-animation {
  0% { background-position: 100% 0; }
  100% { background-position: -100% 0; }
}


/*
  ==============================================
  CUSTOM MAP CONTROL STYLES
  ==============================================
*/
/* --- START: SURGICAL REPLACEMENT (THEME-AWARE MAP CONTROLS) --- */
.leaflet-control-layers,
.leaflet-control-zoom {
  @apply bg-background-default/80 dark:bg-background-subtle/80 backdrop-blur-md shadow-[0_4px_12px_rgba(0,0,0,0.05)] border border-stroke-default rounded-lg;
}

.leaflet-control-layers-base label span,
.leaflet-control-zoom a {
  @apply !text-content-default;
}

.leaflet-control-layers-selector {
  @apply mt-0.5;
}

.leaflet-control-zoom-in, .leaflet-control-zoom-out {
    @apply !bg-transparent hover:!bg-background-inset;
}
/* --- END: SURGICAL REPLACEMENT (THEME-AWARE MAP CONTROLS) --- */


/*
  ==============================================
  INSTRUCTION TOAST ANIMATIONS
  ==============================================
*/
@layer utilities {
  @keyframes fade-in-down {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in-down {
    animation: fade-in-down 0.5s ease-out forwards;
  }
}

/*
  ==============================================
  MOBILE RESPONSIVENESS - A FOCUSED EXPERIENCE
  ==============================================
*/
@media (max-width: 767px) {
  /* --- The Focus View: Canvas as the Stage, Controls as the Tool --- */
  /* When a measurement is active, the layout transforms. The canvas fills the screen,
     and the controls are presented in an ergonomic sheet at the bottom. */
  .mobile-focus-view #control-panel {
    /* --- START: SURGICAL MODIFICATION --- */
    @apply absolute bottom-0 left-0 w-full bg-background-subtle z-20;
    @apply border-t border-stroke-default rounded-t-2xl shadow-[0_-4px_20px_rgba(0,0,0,0.1)];
    /* --- END: SURGICAL MODIFICATION --- */
    max-height: 85vh;
    overflow-y: auto;
    transition: transform 0.3s ease-in-out;
  }

  .mobile-focus-view #display-panel {
    @apply fixed inset-0 z-10 p-0;
  }

  .mobile-focus-view #image-canvas {
    @apply w-full h-full object-contain rounded-none;
  }

  /* --- Session History: A Timeline of Cards --- */
  /* On mobile, the data table is reimagined as a vertical timeline of cards,
     making each result a clear, self-contained entry. */
  .mobile-cards-table thead {
    @apply hidden;
  }
  .mobile-cards-table tr {
    /* --- START: SURGICAL MODIFICATION --- */
    @apply block border border-stroke-default rounded-xl mb-4 shadow-sm bg-background-default;
    /* --- END: SURGICAL MODIFICATION --- */
  }
  .mobile-cards-table td {
    /* --- START: SURGICAL MODIFICATION --- */
    @apply flex justify-between items-center p-3 border-b border-stroke-subtle text-sm;
    /* --- END: SURGICAL MODIFICATION --- */
  }
  .mobile-cards-table td:last-child {
    @apply border-b-0;
  }
  .mobile-cards-table td::before {
    content: attr(data-label);
    /* --- START: SURGICAL MODIFICATION --- */
    @apply font-semibold text-content-subtle text-left pr-4;
    /* --- END: SURGICAL MODIFICATION --- */
  }
  .mobile-cards-table td > * {
    @apply text-right;
  }
  .mobile-cards-table td[data-label="Actions"] > button {
    @apply ml-auto; /* Ensure delete button is pushed right */
  }
}

/* 
  ==============================================
  WEBXR AR VIEWPORT FIX
  ==============================================
  Ensures Three.js canvas properly fills viewport during AR sessions
  without being shifted by browser chrome (address bar, etc.)
*/
canvas {
  /* Prevent canvas from being shifted by touch gestures */
  touch-action: none;
  /* Use safe area insets for notched devices */
  padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}

/*
  ==============================================
  PHASE 5: SLIDE-UP ANIMATION
  ==============================================
  Smooth slide-up animation for additional details panel
*/
@keyframes slide-up {
  from {
    transform: translateY(100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.animate-slide-up {
  animation: slide-up 0.3s ease-out forwards;
}

/* 
  ==============================================
  MOBILE BROWSER UI SAFE POSITIONING
  ==============================================
  Critical fix for floating controls on mobile browsers (Chrome, Brave, Safari, Firefox)
  
  Problem: Mobile browsers have dynamic bottom navigation bars (48-56px) that obscure
  fixed-position elements. Standard CSS 'bottom' doesn't account for this.
  
  Solution: Multi-layer safety approach used by Instagram, Google Maps, YouTube:
    Layer 1: env(safe-area-inset-bottom) - iOS notches & Android gesture bars
    Layer 2: max(80px, ...) - Clearance above browser bottom nav
    Layer 3: Responsive - 80px mobile, 24px desktop
  
  Layout Strategy:
    - LEFT side: Undo/Confirm controls (avoid overlap with "Show Panel" button)
    - RIGHT side: Floating action button ("Show Panel")
    - Distributed layout prevents UI clustering (Instagram Stories pattern)
  
  Best Practices:
    - Always use 'fixed' not 'absolute' for viewport-level positioning
    - Use z-50 or higher to ensure controls are on top
    - Combine with backdrop-blur for visual separation
    - Distribute controls across screen edges (left/right) to avoid overlap
  
  Reference: https://developer.mozilla.org/en-US/docs/Web/CSS/env#safe-area-inset-bottom
*/
.safe-area-bottom {
  bottom: max(80px, calc(1.5rem + env(safe-area-inset-bottom, 0px)));
}

/* Desktop override - smaller offset when there's no mobile browser UI */
@media (min-width: 768px) {
  .safe-area-bottom {
    bottom: max(24px, calc(1.5rem + env(safe-area-inset-bottom, 0px)));
  }
}

/*
  ==============================================
  COMPACT TREE MAP POPUP STYLES
  ==============================================
  Clean, professional map popup with proper light/dark mode support
*/

/* Override Leaflet's default popup styles */
.leaflet-popup-content-wrapper {
  @apply !bg-background-default !rounded-xl !shadow-lg border border-stroke-default !p-0;
  overflow: hidden;
}

.leaflet-popup-content {
  @apply !m-0 w-full;
}

.leaflet-popup-tip {
  @apply !bg-background-default border-l border-b border-stroke-default;
}

/* Close button styling */
.leaflet-popup-close-button {
  @apply !text-content-subtle hover:!text-content-default !text-2xl !leading-none;
  top: 8px !important;
  right: 8px !important;
}

/* Compact tree card layout */
.compact-tree-card {
  @apply flex flex-col;
  width: 100%;
}

.popup-image {
  @apply w-full h-24 object-cover;
  margin: 0;
}

.popup-header {
  @apply px-3 pt-3 pb-2;
}

.popup-scientific-name {
  @apply text-sm font-bold italic text-content-default leading-tight m-0;
}

.popup-common-name {
  @apply text-xs text-content-subtle capitalize mt-1 m-0;
}

/* Compact metrics grid */
.popup-metrics {
  @apply grid grid-cols-3 gap-0 border-t border-b border-stroke-subtle;
}

.metric-item {
  @apply flex flex-col items-center justify-center py-2 px-1;
  border-right: 1px solid rgb(var(--stroke-subtle));
}

.metric-item:last-child {
  border-right: none;
}

.metric-label {
  @apply text-[10px] text-content-subtle uppercase tracking-wide mb-0.5;
}

.metric-value {
  @apply text-xs font-mono font-semibold text-content-default;
}

/* Footer with status and button */
.popup-footer {
  @apply flex items-center justify-center px-3 py-2 border-b border-stroke-subtle;
}

.popup-actions {
  @apply flex flex-col gap-2 px-3 py-2;
}

.status-badge {
  @apply inline-flex items-center px-2 py-0.5 text-[10px] font-semibold rounded-full uppercase tracking-wide;
}

.status-complete {
  @apply bg-status-success/10 text-status-success;
}

.status-verified {
  @apply bg-brand-secondary/10 text-brand-secondary;
}

.status-pending {
  @apply bg-brand-accent/10 text-brand-accent;
}

.status-progress {
  @apply bg-brand-primary/10 text-brand-primary;
}

.status-unknown {
  @apply bg-background-subtle text-content-subtle;
}

.view-details-btn {
  @apply flex items-center gap-1 px-3 py-1.5 bg-brand-primary text-content-on-brand rounded-lg text-xs font-medium;
  @apply hover:bg-brand-primary-hover transition-colors;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.view-details-btn:hover {
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
}

.view-details-btn-full {
  @apply w-full flex items-center justify-center gap-1.5 px-3 py-2 bg-brand-primary text-white rounded-lg text-xs font-medium;
  @apply hover:bg-brand-primary-hover transition-colors;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.view-details-btn-full:hover {
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
}

.analyze-btn {
  @apply flex items-center gap-1 px-3 py-1.5 bg-brand-accent text-content-on-brand rounded-lg text-xs font-medium;
  @apply hover:bg-brand-accent-hover transition-colors;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.analyze-btn:hover {
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
}

.analyze-btn-full {
  @apply w-full flex items-center justify-center gap-1.5 px-3 py-2 bg-brand-accent text-white rounded-lg text-xs font-medium;
  @apply hover:bg-brand-accent-hover transition-colors;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.analyze-btn-full:hover {
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
}

/* Dark mode specific enhancements */
:root.dark .leaflet-popup-content-wrapper {
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
}

:root.dark .view-details-btn {
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

:root.dark .view-details-btn:hover {
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
}

/* Ensure Leaflet map doesn't interfere with modals */
.leaflet-container {
  z-index: 1;
}

/* CRITICAL: Leaflet popup must be above map */
.leaflet-popup-pane {
  z-index: 1100 !important;
}

.leaflet-popup {
  z-index: 1100 !important;
}

.leaflet-top,
.leaflet-bottom {
  z-index: 1000;
}

/* Custom tree marker styling */
.custom-tree-marker {
  background: transparent !important;
  border: none !important;
}

.custom-tree-marker > div {
  cursor: pointer;
  transition: transform 0.2s ease;
}

.custom-tree-marker:hover > div {
  transform: scale(1.1);
}

/* --- START: WEBXR AR VIEWPORT FIX --- */
/*
  ==============================================
  AR FULLSCREEN & SAFE AREA UTILITIES
  ==============================================
  Industry-standard patterns from Google WebXR, 8thWall, Meta Immersive Web
*/

/* Full viewport overlay with dynamic height (adapts to mobile browser UI) */
.ar-fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  width: 100dvw; /* Dynamic viewport width - adapts when browser UI changes */
  height: 100vh;
  height: 100dvh; /* Dynamic viewport height - crucial for mobile AR */
  overflow: hidden;
  -webkit-overflow-scrolling: touch;
}

/* Safe area inset utilities for AR overlays (iOS notch, home indicator) */
.ar-safe-top {
  top: env(safe-area-inset-top, 0);
}

.ar-safe-bottom {
  bottom: env(safe-area-inset-bottom, 0);
}

.ar-safe-left {
  left: env(safe-area-inset-left, 0);
}

.ar-safe-right {
  right: env(safe-area-inset-right, 0);
}

/* Padding utilities for AR UI elements (ensures visibility) */
.ar-padding-top {
  padding-top: env(safe-area-inset-top, 1rem);
}

.ar-padding-bottom {
  padding-bottom: max(1.5rem, env(safe-area-inset-bottom, 1.5rem));
}

/* Prevent text selection and callouts during AR interactions */
.ar-no-select {
  -webkit-user-select: none;
  user-select: none;
  -webkit-touch-callout: none;
}
/* --- END: WEBXR AR VIEWPORT FIX --- */


